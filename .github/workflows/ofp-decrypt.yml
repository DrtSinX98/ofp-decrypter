name: OFP Decrypter by Area69Labs

on:
  workflow_dispatch:
    inputs:
      ofp_link:
        description: 'OFP Firmaware Link'
        required: true
      filename:
        description: 'The filename You want in output (make unique)'
        required: true
      devicetype:
        description: 'Specify Your Device type. { For Qualcomm (QC) FOR MEDIATEK (MTK) }'
        required: true
      simage:
        description: 'Do you want to merege super images, if yes then type <YES>'
        required: false
        default: 'NO'
      bigfile:
        description: 'Set if your ofp file is more than 8GB. Setting to yes will take more time.'
        required: false
        default: 'NO'        

env:
  OFP_LINK: ${{ github.event.inputs.ofp_link }}
  FILENAME: ${{ github.event.inputs.filename }}
  DTYPE: ${{ github.event.inputs.devicetype }}
  SIMG: ${{ github.event.inputs.simage }}
  BFILE: ${{ github.event.inputs.bigfile }}
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: CleanUp Enviroment
        if: ${{ env.BFILE == YES }}
        uses: rokibhasansagar/slimhub_actions@main

      - name: Download OFP Firmware
        run: |
          aria2c -c -s16 -x16 "$OFP_LINK" 2>/dev/null || wget -q --show-progress "$OFP_LINK"
          OFPFILE=${OFP_LINK##*/}
          echo "OFP_FILE=${OFPFILE}" >> ${GITHUB_ENV}
          OFPNAME=${OFPFILE%.*}
          echo "OFP_NAME=${OFPNAME}" >> ${GITHUB_ENV}

      - name: Prepare Decrypter and Decrypt OFP
        shell: bash
        run: |
          sudo apt-fast update -qqy
          sudo apt-fast install -qqy openssl rsync sshpass
          sudo pip3 install --upgrade pip wheel setuptools
          sudo pip3 install --upgrade pycryptodome
          sudo apt install simg2img
          git clone https://github.com/bkerler/oppo_decrypt.git --depth=1
          dtype=$DTYPE
          if [ $dtype == QC ]
          then
              printf "Trying to Decrypt QC OFP...\n"
              python3 ./oppo_decrypt/ofp_mtk_decrypt.py "$OFP_FILE" out 2>/dev/null

          elif [ $dtype == MTK ]
          then
              printf "Trying to Decrypt MTK OFP...\n"
              python3 ./oppo_decrypt/ofp_mtk_decrypt.py "$OFP_FILE" out 2>/dev/null

          else
              printf "Specify your Device Type...\n"
              printf "Cancelling Build\n"
          fi

      - name: Combine super images
        shell: bash
        run: |
          simg=$SIMG
          if [ $simg == YES ]
          then
              print "Merging images"
              mkdir super
              mv out/*super*.img super/
              cd super
              simg2img *super*.img super.img
              mv super.img ../out         
              cd ..
            
          elif [ $simg == NO ]
          then
              echo "Not merging images"
          fi

      - name: Compress Decrypted Zip
        shell: bash
        run: |
          zip -r9 Decrypted_"${FILENAME}".zip out/
          simg=$SIMG
          if [ $simg == YES ]
          then
              zip -r superimages.zip super/
              
          elif [ $simg == NO ]
          then
              echo "Not zipping superimages"
          fi         
    
      - name: Upload Decrypted Zip
        shell: bash
        run: |
          wget https://sauraj.rommirrorer.workers.dev/0:/rclonesetup.sh
          bash rclonesetup.sh
          rclone -P copy Decrypted_"${FILENAME}".zip rom:/decrypted_ofp/"${FILENAME}"_decrypt
          simg=$SIMG
          if [ $simg == YES ]
          then
              rclone -P copy superimages.zip rom:/decrypted_ofp/"${FILENAME}"_decrypt
              
          elif [ $simg == NO ]
          then
              echo "Not Uploading superimages"
          fi         
          
      - name: DOWNLOAD LINK
        run: |
          echo -e "zip LINK: https://sauraj.rommirrorer.workers.dev/0:/decrypted_ofp/${FILENAME}_decrypt"
          echo "Edited By Sauraj"
          
          
